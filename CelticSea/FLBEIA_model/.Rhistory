intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>%
select(-Season,-SeasonType) %>% group_by_at(vars(-CANUM,-CATON_in_kg)) %>%
summarise(CATON_in_kg=sum(unique(CATON_in_kg),na.rm=T),CANUM=sum(CANUM,na.rm = T))
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER_old <- intercatch_canum_QUARTER %>% %>% group_by_at(vars(-CANUM,-CATON_in_kg)) %>%
summarise(CATON_in_kg=sum(unique(CATON_in_kg),na.rm=T),CANUM=sum(CANUM,na.rm = T))
intercatch_canum_QUARTER_old <- intercatch_canum_QUARTER %>% group_by_at(vars(-CANUM,-CATON_in_kg)) %>%
summarise(CATON_in_kg=sum(unique(CATON_in_kg),na.rm=T),CANUM=sum(CANUM,na.rm = T))
intercatch_canum_QUARTER_new <- intercatch_canum_QUARTER %>% group_by(-CANUM,-CATON_in_kg) %>% summarise(CATON_in_kg=sum(unique(CATON_in_kg),na.rm=T),CANUM=sum(CANUM,na.rm = T))
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER_old <- intercatch_canum_QUARTER %>% group_by_at(vars(-CANUM,-CATON_in_kg)) %>%
summarise(CATON_in_kg=sum(unique(CATON_in_kg),na.rm=T),CANUM=sum(CANUM,na.rm = T))
intercatch_canum_QUARTER_new <- intercatch_canum_QUARTER %>% group_by(-CANUM,-CATON_in_kg) %>% summarise(CATON_in_kg=sum(unique(CATON_in_kg),na.rm=T),CANUM=sum(CANUM,na.rm = T))
View(intercatch_canum_QUARTER_new)
View(intercatch_canum_QUARTER_old)
head(intercatch_canum_QUARTER)
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
head(intercatch_canum_QUARTER)
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER_old <- intercatch_canum_QUARTER %>% group_by_at(vars(-CANUM,-CATON_in_kg)) %>%
summarise(CATON_in_kg=sum(unique(CATON_in_kg),na.rm=T),CANUM=sum(CANUM,na.rm = T), MeanWeight_in_g=weighted.mean(as.numeric(MeanWeight_in_g),CANUM))
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by_at(vars(-CANUM,-CATON_in_kg)) %>%
summarise(CATON_in_kg=sum(unique(CATON_in_kg),na.rm=T),CANUM=sum(CANUM,na.rm = T))
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by_at(vars(-CANUM,-MeanWeight_in_g)) %>% summarise(MeanWeight_in_g=weighted.mean(as.numeric(MeanWeight_in_g),CANUM),CANUM=sum(CANUM,na.rm = T)) %>% ungroup()
warnings()
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by_at(vars(-CANUM,-CATON_in_kg)) %>%
summarise(CATON_in_kg=sum(unique(CATON_in_kg),na.rm=T),CANUM=sum(CANUM,na.rm = T))
View(intercatch_canum_QUARTER)
library(readr)
intercatch_caton_summary <- read_csv("results/clean_data/intercatch_caton_summary.csv")
View(intercatch_caton_summary)
unique(intercatch_canum_QUARTER$Stock)
sun(intercatch_caton_summary$Landings[intercatch_caton_summary$Stock == "sol.27.7d" & intercatch_caton_summary$Year == 2019], na.rm=T)
sum(intercatch_caton_summary$Landings[intercatch_caton_summary$Stock == "sol.27.7d" & intercatch_caton_summary$Year == 2019], na.rm=T)
sum(intercatch_canum$CATON_in_kg[intercatch_canum$Stock == "sol.27.7d" & intercatch_canum$Datayear == 2019], na.rm=T)
sum(intercatch_canum$CATON_in_kg[intercatch_canum$CatchCat == "Landings", intercatch_canum$Stock == "sol.27.7d" & intercatch_canum$Datayear == 2019], na.rm=T)
sum(intercatch_canum$CATON_in_kg[intercatch_canum$CatchCat == "Landings"& intercatch_canum$Stock == "sol.27.7d" & intercatch_canum$Datayear == 2019], na.rm=T)
sum(intercatch_canum$CATON_in_kg[intercatch_canum$CatchCat == "Landings" & intercatch_canum$Stock == "sol.27.7d" & intercatch_canum$Datayear == 2019], na.rm=T)
head(intercatch_canum_QUARTER)
head(intercatch_canum_QUARTER)
head(intercatch_canum_QUARTER)
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,   Country, Fleet, CatchCat, lvl4,  Area,  Species, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = mean(MeanWeight_in_g, na.rm=T), CANUM=sum(CANUM,na.rm = T)))%>% data.frame()
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,   Country, Fleet, CatchCat, lvl4,  Area,  Species, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = mean(MeanWeight_in_g, na.rm=T), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
warnings()
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
str(intercatch_canum_QUARTER)
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,   Country, Fleet, CatchCat, lvl4,  Area,  Species, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = mean(as.numeric(MeanWeight_in_g), na.rm=T), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
str(intercatch_canum_QUARTER)
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,   Country, Fleet, CatchCat, lvl4,  Area,  Species, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = mean(as.numeric(MeanWeight_in_g), na.rm=T), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,   Country, Fleet, CatchCat, lvl4,  Area,  Species, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = mean(as.numeric(MeanWeight_in_g), na.rm=T), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
warnings()
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER$MeanWeight_in_g <- as.numeric(intercatch_canum_QUARTER$MeanWeight_in_g)
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
View(intercatch_canum_QUARTER)
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER$MeanWeight_in_g <- as.numeric(intercatch_canum_QUARTER$MeanWeight_in_g)
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,  Country, Fleet, CatchCat, lvl4,  Area,  Species, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
warnings()
intercatch_canum <- rbind(intercatch_canum_YEARS,intercatch_canum_QUARTER)
names(intercatch_canum
)
length(unique(intercatch_canum_saftey_check$CANUM)-length(unique(intercatch_canum$CANUM)# This is not a valid sanity check as they are repeated values
)
length(unique(intercatch_canum_saftey_check$CANUM))-length(unique(intercatch_canum$CANUM))# This is not a valid sanity check as they are repeated values
sum(intercatch_canum_sanity$CANUM)-sum(intercatch_canum$CANUM) # This is not a valid sanity check as they are repeated values
sum(intercatch_canum_saftey_check$CANUM)-sum(intercatch_canum$CANUM) # This is not a valid sanity check as they are repeated values
unique(intercatch_canum$CatchCat)
unique(intercatch_canum$ageorlength
)
intercatch_canum_saftey_check$CANUMType
unique(intercatch_canum_saftey_check$CANUMType)
# 01 - InterCatch CANUM ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
gc()
rm(list = ls())
gc()
#gc()
#rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
# 01 - InterCatch CANUM ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
intercatch_canum$CANUMType
# Data prep
# Preprocess data,
## Before: InterCatch extraction, data raised external to InterCatch, and ALK's
## After:  Age structure from InterCatch
# Notes: User must make sure that:
# 1 - factors are turned to characters,
# 2 - dim of data frame does not change shape during cleaning process
# Data sources vary per stock:
#       - InterCatch CANUM with distribution: meg.27.7b-k8abd, sol.27.7fg
#       - Raised outside InterCatch: cod.27.7e-k, had.27.7b-k, whg.27.7b-ce-k, mon.27.78abd
#gc()
#rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
# 01 - InterCatch CANUM ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
#subset for case study area
intercatch_canum <- intercatch_canum[intercatch_canum$Area %in% c("27.7"  , "27.7.b" , "27.7.c","27.7.c.1","27.7.c.2" , "27.7.d",  "27.7.e",  "27.7.f" , "27.7.g" , "27.7.h",  "27.7.j","27.7.j.1","27.7.j.2" , "27.7.k","27.7.k.1","27.7.k.2" ))
intercatch_canum_saftey_check <- intercatch_canum #save for sanity checking later
# ~ Area fix ####
area_spp_fix <- read.csv("bootstrap/data/supporting_files/Area_lookup.csv")
names(area_spp_fix) <- c("Area" ,"Standard","ICES_mix_correct", "ICES_FU","species_mix_FU" )
intercatch_canum <- left_join(intercatch_canum,area_spp_fix, by = "Area" )
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Area <- intercatch_canum$ICES_mix_correct
intercatch_canum <- intercatch_canum[-c(22,23,24,25)]
# ~ Country fix  ####
Country_Lookup <- read_xlsx("bootstrap/data/supporting_files/Country_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,Country_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Country <- intercatch_canum$CorrectCountry
intercatch_canum <- intercatch_canum[-c(25)]
# ~ Species fix ####
intercatch_canum$Species <- toupper(substr(intercatch_canum$Stock,1,3))
# ~ Métier level 4 fix ####
intercatch_canum$lvl4 <- substr(intercatch_canum$Fleet,1,7)
lvl4_Lookup <- read_xlsx("bootstrap/data/supporting_files/Metier_lvl4_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,lvl4_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$lvl4_new <- ifelse(is.na(intercatch_canum$Correct_lvl4),intercatch_canum$lvl4, intercatch_canum$Correct_lvl4)
intercatch_canum$lvl4 <- intercatch_canum$lvl4_new
intercatch_canum <- intercatch_canum[-c(25,26,27)]
# ~ Remove unwanted data ####
intercatch_canum <-intercatch_canum [intercatch_canum$CatchCat %in% c("Discards", "Landings"),]
# #~ Remove Quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","CANUMType", "ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,  Country, Fleet, CatchCat, lvl4,  Area,  Species, CANUMType, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
#NOTE - warnings are due to no mean weights for HKE in 2009 for UKN, UKE and UKS.
intercatch_canum <- rbind(intercatch_canum_YEARS,intercatch_canum_QUARTER)
View(intercatch_canum)
sort(unique(intercatch_canum$Species))
sort(unique(intercatch_canum$Stock))
unique(intercatch_canum$CANUMType[intercatch_canum$Stock == "hke.27.3a46-8abd"])
# ~ SOP check ####
# Check the caton and numbers at age*meanweight matches, SOP is in grams
intercatch_canum$SOP <- intercatch_canum %>% mutate(SOP=as.numeric(Number_at_age)*as.numeric(MeanWeight_in_g))
names(intercatch_canum
)
# ~ SOP check ####
# Check the caton and numbers at age*meanweight matches, SOP is in grams
intercatch_canum$SOP <- intercatch_canum %>% mutate(SOP=as.numeric(CANUM)*as.numeric(MeanWeight_in_g))
# Data prep
# Preprocess data,
## Before: InterCatch extraction, data raised external to InterCatch, and ALK's
## After:  Age structure from InterCatch
# Notes: User must make sure that:
# 1 - factors are turned to characters,
# 2 - dim of data frame does not change shape during cleaning process
# Data sources vary per stock:
#       - InterCatch CANUM with distribution: meg.27.7b-k8abd, sol.27.7fg
#       - Raised outside InterCatch: cod.27.7e-k, had.27.7b-k, whg.27.7b-ce-k, mon.27.78abd
#gc()
#rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
# 01 - InterCatch CANUM ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
#subset for case study area
intercatch_canum <- intercatch_canum[intercatch_canum$Area %in% c("27.7"  , "27.7.b" , "27.7.c","27.7.c.1","27.7.c.2" , "27.7.d",  "27.7.e",  "27.7.f" , "27.7.g" , "27.7.h",  "27.7.j","27.7.j.1","27.7.j.2" , "27.7.k","27.7.k.1","27.7.k.2" ))
intercatch_canum_saftey_check <- intercatch_canum #save for sanity checking later
# ~ Area fix ####
area_spp_fix <- read.csv("bootstrap/data/supporting_files/Area_lookup.csv")
names(area_spp_fix) <- c("Area" ,"Standard","ICES_mix_correct", "ICES_FU","species_mix_FU" )
intercatch_canum <- left_join(intercatch_canum,area_spp_fix, by = "Area" )
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Area <- intercatch_canum$ICES_mix_correct
intercatch_canum <- intercatch_canum[-c(22,23,24,25)]
# ~ Country fix  ####
Country_Lookup <- read_xlsx("bootstrap/data/supporting_files/Country_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,Country_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Country <- intercatch_canum$CorrectCountry
intercatch_canum <- intercatch_canum[-c(25)]
# ~ Species fix ####
intercatch_canum$Species <- toupper(substr(intercatch_canum$Stock,1,3))
# ~ Métier level 4 fix ####
intercatch_canum$lvl4 <- substr(intercatch_canum$Fleet,1,7)
lvl4_Lookup <- read_xlsx("bootstrap/data/supporting_files/Metier_lvl4_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,lvl4_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$lvl4_new <- ifelse(is.na(intercatch_canum$Correct_lvl4),intercatch_canum$lvl4, intercatch_canum$Correct_lvl4)
intercatch_canum$lvl4 <- intercatch_canum$lvl4_new
intercatch_canum <- intercatch_canum[-c(25,26,27)]
# ~ Remove unwanted data ####
intercatch_canum <-intercatch_canum [intercatch_canum$CatchCat %in% c("Discards", "Landings"),]
#~ Remove quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","CANUMType", "ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,  Country, Fleet, CatchCat, lvl4,  Area,  Species, CANUMType, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
#NOTE - warnings are due to no mean weights for HKE in 2009 for UKN, UKE and UKS.
intercatch_canum <- rbind(intercatch_canum_YEARS,intercatch_canum_QUARTER)
#sum(intercatch_canum_saftey_check$CANUM)-sum(intercatch_canum$CANUM) # This is not a valid sanity check as they are repeated values
# ~ SOP check ####
# Data prep
# Preprocess data,
## Before: InterCatch extraction, data raised external to InterCatch, and ALK's
## After:  Age structure from InterCatch
# Notes: User must make sure that:
# 1 - factors are turned to characters,
# 2 - dim of data frame does not change shape during cleaning process
# Data sources vary per stock:
#       - InterCatch CANUM with distribution: meg.27.7b-k8abd, sol.27.7fg
#       - Raised outside InterCatch: cod.27.7e-k, had.27.7b-k, whg.27.7b-ce-k, mon.27.78abd
#gc()
#rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
# 01 - InterCatch CANUM ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
#subset for case study area
intercatch_canum <- intercatch_canum[intercatch_canum$Area %in% c("27.7"  , "27.7.b" , "27.7.c","27.7.c.1","27.7.c.2" , "27.7.d",  "27.7.e",  "27.7.f" , "27.7.g" , "27.7.h",  "27.7.j","27.7.j.1","27.7.j.2" , "27.7.k","27.7.k.1","27.7.k.2" ),]
intercatch_canum_saftey_check <- intercatch_canum #save for sanity checking later
# ~ Area fix ####
area_spp_fix <- read.csv("bootstrap/data/supporting_files/Area_lookup.csv")
names(area_spp_fix) <- c("Area" ,"Standard","ICES_mix_correct", "ICES_FU","species_mix_FU" )
intercatch_canum <- left_join(intercatch_canum,area_spp_fix, by = "Area" )
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Area <- intercatch_canum$ICES_mix_correct
intercatch_canum <- intercatch_canum[-c(22,23,24,25)]
# ~ Country fix  ####
Country_Lookup <- read_xlsx("bootstrap/data/supporting_files/Country_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,Country_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Country <- intercatch_canum$CorrectCountry
intercatch_canum <- intercatch_canum[-c(25)]
# ~ Species fix ####
intercatch_canum$Species <- toupper(substr(intercatch_canum$Stock,1,3))
# ~ Métier level 4 fix ####
intercatch_canum$lvl4 <- substr(intercatch_canum$Fleet,1,7)
lvl4_Lookup <- read_xlsx("bootstrap/data/supporting_files/Metier_lvl4_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,lvl4_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$lvl4_new <- ifelse(is.na(intercatch_canum$Correct_lvl4),intercatch_canum$lvl4, intercatch_canum$Correct_lvl4)
intercatch_canum$lvl4 <- intercatch_canum$lvl4_new
intercatch_canum <- intercatch_canum[-c(25,26,27)]
# ~ Remove unwanted data ####
intercatch_canum <-intercatch_canum [intercatch_canum$CatchCat %in% c("Discards", "Landings"),]
#~ Remove quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","CANUMType", "ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,  Country, Fleet, CatchCat, lvl4,  Area,  Species, CANUMType, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
#NOTE - warnings are due to no mean weights for HKE in 2009 for UKN, UKE and UKS.
intercatch_canum <- rbind(intercatch_canum_YEARS,intercatch_canum_QUARTER)
#sum(intercatch_canum_saftey_check$CANUM)-sum(intercatch_canum$CANUM) # This is not a valid sanity check as they are repeated values
# ~ SOP check ####
# Check the caton and numbers at age*meanweight matches, SOP is in grams
# ~ SOP check ####
# Check the caton and numbers at age*meanweight matches, SOP is in grams
intercatch_canum$SOP <- as.numeric(intercatch_canum$CANUM)*as.numeric(intercatch_canum$MeanWeight_in_g))
# ~ SOP check ####
# Check the caton and numbers at age*meanweight matches, SOP is in grams
intercatch_canum$SOP <- as.numeric(intercatch_canum$CANUM)*as.numeric(intercatch_canum$MeanWeight_in_g)
View(intercatch_canum)
### so this will tell us if the SOP and the caton_kg are different (they should be the same or within very small tolerances)
intercatch_canum3 <- intercatch_canum %>% group_by_at(vars(-SOP,-MeanWeight_in_g,-Number_at_age,-ageorlength)) %>%  mutate(SOP_SUM=sum(SOP,na.rm = T)/1000)%>% mutate(diff=SOP_SUM-as.numeric(CATON_in_kg)) %>% ungroup()
names(intercatch_canum)
### so this will tell us if the SOP and the caton_kg are different (they should be the same or within very small tolerances)
intercatch_canum3 <- intercatch_canum %>% group_by_at(vars(-SOP,-MeanWeight_in_g,-CANUM,-ageorlength)) %>%  mutate(SOP_SUM=sum(SOP,na.rm = T)/1000)%>% mutate(diff=SOP_SUM-as.numeric(CATON_in_kg)) %>% ungroup()
View(intercatch_canum3)
intercatch_canum3 <- intercatch_canum %>% group_by_at(vars(-SOP,-MeanWeight_in_g,-CANUM,-ageorlength)) %>%  mutate(SOP_SUM=sum(SOP,na.rm = T)/1000)%>% mutate(diff=SOP_SUM-as.numeric(CATON_in_kg)) %>% data.frame()
intercatch_canum3 <- intercatch_canum %>% group_by_at(vars(-SOP,-MeanWeight_in_g,-CANUM,-ageorlength))
# ~ SOP check ####
# Check the caton and numbers at age*meanweight matches, SOP is in grams
intercatch_canum$SOP <- (as.numeric(intercatch_canum$CANUM)*as.numeric(intercatch_canum$MeanWeight_in_g))/1000 # put in kg
### SOP and the caton_kg should be the same or within very small tolerances)
intercatch_canum$diff <- diff= intercatch_canum$SOP -as.numeric(intercatch_canum$CATON_in_kg)) %>% data.frame()
### SOP and the caton_kg should be the same or within very small tolerances)
intercatch_canum$diff <- intercatch_canum$SOP - as.numeric(intercatch_canum$CATON_in_kg)
View(intercatch_canum)
# ~ SOP check ####
# first remove all zeros
intercatch_canum <- intercatch_canum[intercatch_canum$CANUM>0,]
intercatch_canum <- intercatch_canum[intercatch_canum$MeanWeight_in_g>0,] # why would there be fish with an age and no weight?
intercatch_canum <- intercatch_canum[!is.na(intercatch_canum$CATON_in_kg),]
# Data prep
# Preprocess data,
## Before: InterCatch extraction, data raised external to InterCatch, and ALK's
## After:  Age structure from InterCatch
# Notes: User must make sure that:
# 1 - factors are turned to characters,
# 2 - dim of data frame does not change shape during cleaning process
# Data sources vary per stock:
#       - InterCatch CANUM with distribution: meg.27.7b-k8abd, sol.27.7fg
#       - Raised outside InterCatch: cod.27.7e-k, had.27.7b-k, whg.27.7b-ce-k, mon.27.78abd
gc()
rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
# 01 - InterCatch CANUM ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
#subset for case study area
intercatch_canum <- intercatch_canum[intercatch_canum$Area %in% c("27.7"  , "27.7.b" , "27.7.c","27.7.c.1","27.7.c.2" , "27.7.d",  "27.7.e",  "27.7.f" , "27.7.g" , "27.7.h",  "27.7.j","27.7.j.1","27.7.j.2" , "27.7.k","27.7.k.1","27.7.k.2" ),]
intercatch_canum_saftey_check <- intercatch_canum #save for sanity checking later
# ~ Area fix ####
area_spp_fix <- read.csv("bootstrap/data/supporting_files/Area_lookup.csv")
names(area_spp_fix) <- c("Area" ,"Standard","ICES_mix_correct", "ICES_FU","species_mix_FU" )
intercatch_canum <- left_join(intercatch_canum,area_spp_fix, by = "Area" )
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Area <- intercatch_canum$ICES_mix_correct
intercatch_canum <- intercatch_canum[-c(22,23,24,25)]
# ~ Country fix  ####
Country_Lookup <- read_xlsx("bootstrap/data/supporting_files/Country_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,Country_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Country <- intercatch_canum$CorrectCountry
intercatch_canum <- intercatch_canum[-c(25)]
# ~ Species fix ####
intercatch_canum$Species <- toupper(substr(intercatch_canum$Stock,1,3))
# ~ Métier level 4 fix ####
intercatch_canum$lvl4 <- substr(intercatch_canum$Fleet,1,7)
lvl4_Lookup <- read_xlsx("bootstrap/data/supporting_files/Metier_lvl4_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,lvl4_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$lvl4_new <- ifelse(is.na(intercatch_canum$Correct_lvl4),intercatch_canum$lvl4, intercatch_canum$Correct_lvl4)
intercatch_canum$lvl4 <- intercatch_canum$lvl4_new
intercatch_canum <- intercatch_canum[-c(25,26,27)]
# ~ Remove unwanted data ####
intercatch_canum <-intercatch_canum [intercatch_canum$CatchCat %in% c("Discards", "Landings"),]
#~ Remove quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","CANUMType", "ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,  Country, Fleet, CatchCat, lvl4,  Area,  Species, CANUMType, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
#NOTE - warnings are due to no mean weights for HKE in 2009 for UKN, UKE and UKS.
intercatch_canum <- rbind(intercatch_canum_YEARS,intercatch_canum_QUARTER)
#sum(intercatch_canum_saftey_check$CANUM)-sum(intercatch_canum$CANUM) # This is not a valid sanity check as they are repeated values
# ~ SOP check ####
# first remove all zeros
intercatch_canum <- intercatch_canum[intercatch_canum$CANUM>0,]
intercatch_canum <- intercatch_canum[intercatch_canum$MeanWeight_in_g>0,] # why would there be fish with an age and no weight?
intercatch_canum <- intercatch_canum[!is.na(intercatch_canum$CATON_in_kg),]
View(intercatch_canum)
intercatch_canum <- intercatch_canum %>% group_by(Datayear, Stock,  Country, Fleet, CatchCat, lvl4,  Area,  Species, CANUMType, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
# Data prep
# Preprocess data,
## Before: InterCatch extraction, data raised external to InterCatch, and ALK's
## After:  Age structure from InterCatch
# Notes: User must make sure that:
# 1 - factors are turned to characters,
# 2 - dim of data frame does not change shape during cleaning process
# Data sources vary per stock:
#       - InterCatch CANUM with distribution: meg.27.7b-k8abd, sol.27.7fg
#       - Raised outside InterCatch: cod.27.7e-k, had.27.7b-k, whg.27.7b-ce-k, mon.27.78abd
gc()
rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
# 01 - InterCatch CANUM ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
#subset for case study area
intercatch_canum <- intercatch_canum[intercatch_canum$Area %in% c("27.7"  , "27.7.b" , "27.7.c","27.7.c.1","27.7.c.2" , "27.7.d",  "27.7.e",  "27.7.f" , "27.7.g" , "27.7.h",  "27.7.j","27.7.j.1","27.7.j.2" , "27.7.k","27.7.k.1","27.7.k.2" ),]
intercatch_canum_saftey_check <- intercatch_canum #save for sanity checking later
# ~ Area fix ####
area_spp_fix <- read.csv("bootstrap/data/supporting_files/Area_lookup.csv")
names(area_spp_fix) <- c("Area" ,"Standard","ICES_mix_correct", "ICES_FU","species_mix_FU" )
intercatch_canum <- left_join(intercatch_canum,area_spp_fix, by = "Area" )
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Area <- intercatch_canum$ICES_mix_correct
intercatch_canum <- intercatch_canum[-c(22,23,24,25)]
# ~ Country fix  ####
Country_Lookup <- read_xlsx("bootstrap/data/supporting_files/Country_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,Country_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Country <- intercatch_canum$CorrectCountry
intercatch_canum <- intercatch_canum[-c(25)]
# ~ Species fix ####
intercatch_canum$Species <- toupper(substr(intercatch_canum$Stock,1,3))
# ~ Métier level 4 fix ####
intercatch_canum$lvl4 <- substr(intercatch_canum$Fleet,1,7)
lvl4_Lookup <- read_xlsx("bootstrap/data/supporting_files/Metier_lvl4_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,lvl4_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$lvl4_new <- ifelse(is.na(intercatch_canum$Correct_lvl4),intercatch_canum$lvl4, intercatch_canum$Correct_lvl4)
intercatch_canum$lvl4 <- intercatch_canum$lvl4_new
intercatch_canum <- intercatch_canum[-c(25,26,27)]
# ~ Remove unwanted data ####
intercatch_canum <-intercatch_canum [intercatch_canum$CatchCat %in% c("Discards", "Landings"),]
#~ Remove quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"Fleet" ,"CatchCat","lvl4", "Area","Species","CATON_in_kg","CANUMType", "ageorlength","CANUM","MeanWeight_in_g")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,  Country, Fleet, CatchCat, lvl4,  Area,  Species, CANUMType, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
#NOTE - warnings are due to no mean weights for HKE in 2009 for UKN, UKE and UKS.
intercatch_canum <- rbind(intercatch_canum_YEARS,intercatch_canum_QUARTER)
# first remove all zeros
intercatch_canum <- intercatch_canum[intercatch_canum$CANUM>0,]
intercatch_canum <- intercatch_canum[intercatch_canum$MeanWeight_in_g>0,] # why would there be fish with an age and no weight?
intercatch_canum <- intercatch_canum[!is.na(intercatch_canum$CATON_in_kg),]
intercatch_canum <- intercatch_canum %>% group_by(Datayear, Stock,  Country, Fleet, CatchCat, lvl4,  Area,  Species, CANUMType, ageorlength, CATON_in_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
intercatch_canum <- intercatch_canum %>% group_by(Datayear, Stock,  Country, Fleet, CatchCat, lvl4,  Area,  Species, CANUMType, ageorlength) %>% summarise(CATON_in_kg = sum(CATON_in_kg, na.rm=T), MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T))%>% data.frame()
names(intercatch_canum)
# Data prep
# Preprocess data,
## Before: InterCatch extraction, data raised external to InterCatch, and ALK's
## After:  Age structure from InterCatch
# Notes: User must make sure that:
# 1 - factors are turned to characters,
# 2 - dim of data frame does not change shape during cleaning process
# Data sources vary per stock:
#       - InterCatch CANUM with distribution: meg.27.7b-k8abd, sol.27.7fg
#       - Raised outside InterCatch: cod.27.7e-k, had.27.7b-k, whg.27.7b-ce-k, mon.27.78abd
gc()
rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
# 01 - InterCatch CANUM ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
#subset for case study area
intercatch_canum <- intercatch_canum[intercatch_canum$Area %in% c("27.7"  , "27.7.b" , "27.7.c","27.7.c.1","27.7.c.2" , "27.7.d",  "27.7.e",  "27.7.f" , "27.7.g" , "27.7.h",  "27.7.j","27.7.j.1","27.7.j.2" , "27.7.k","27.7.k.1","27.7.k.2" ),]
intercatch_canum_saftey_check <- intercatch_canum #save for sanity checking later
# ~ Area fix ####
area_spp_fix <- read.csv("bootstrap/data/supporting_files/Area_lookup.csv")
names(area_spp_fix) <- c("Area" ,"Standard","ICES_mix_correct", "ICES_FU","species_mix_FU" )
intercatch_canum <- left_join(intercatch_canum,area_spp_fix, by = "Area" )
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Area <- intercatch_canum$ICES_mix_correct
intercatch_canum <- intercatch_canum[-c(22,23,24,25)]
# ~ Country fix  ####
Country_Lookup <- read_xlsx("bootstrap/data/supporting_files/Country_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,Country_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Country <- intercatch_canum$CorrectCountry
intercatch_canum <- intercatch_canum[-c(25)]
# ~ Species fix ####
intercatch_canum$Species <- toupper(substr(intercatch_canum$Stock,1,3))
# ~ Métier level 4 fix ####
intercatch_canum$lvl4 <- substr(intercatch_canum$Fleet,1,7)
lvl4_Lookup <- read_xlsx("bootstrap/data/supporting_files/Metier_lvl4_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,lvl4_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$lvl4_new <- ifelse(is.na(intercatch_canum$Correct_lvl4),intercatch_canum$lvl4, intercatch_canum$Correct_lvl4)
intercatch_canum$lvl4 <- intercatch_canum$lvl4_new
intercatch_canum <- intercatch_canum[-c(25,26,27)]
