intercatch_canum <- intercatch_canum[-c(23,24,25,25)]
# ~ Country fix  ####
Country_Lookup <- read_xlsx("bootstrap/data/supporting_files/Country_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,Country_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Country <- intercatch_canum$CorrectCountry
intercatch_canum <- intercatch_canum[-c(25)]
# ~ Métier level 4 fix ####
intercatch_canum$lvl4 <- substr(intercatch_canum$Fleet,1,7)
lvl4_Lookup <- read_xlsx("bootstrap/data/supporting_files/Metier_lvl4_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,lvl4_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$lvl4_new <- ifelse(is.na(intercatch_canum$Correct_lvl4),intercatch_canum$lvl4, intercatch_canum$Correct_lvl4)
intercatch_canum$lvl4 <- intercatch_canum$lvl4_new
intercatch_canum <- intercatch_canum[-c(26,27,28)]
# Remove length samples
intercatch_canum_hke <- intercatch_canum[intercatch_canum$Stock == "hke.27.3a46-8abd", ]
intercatch_canum <- intercatch_canum[!intercatch_canum$Stock == "hke.27.3a46-8abd", ]
#~ SOP check of baseline data ####
#needs to be done before you aggregate
intercatch_canum_checks <- intercatch_canum %>%   group_by(Datayear, Stock, Country, Area, CatchCat, CANUMType, CATON_in_kg ) %>% summarise(samples_weight_kg = sum(samples_weight_kg, na.rm=T)) %>% mutate(course_difference = (CATON_in_kg -samples_weight_kg) , SOP = (samples_weight_kg/ CATON_in_kg)) %>% data.frame()
ggplot(intercatch_canum_checks[intercatch_canum_checks$Stock == "sol.27.7fg",], aes(CATON_in_kg, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic()+ggtitle("sol.27.7fg")
ggplot(intercatch_canum_checks[intercatch_canum_checks$Stock == "meg.27.7b-k8abd",], aes(CATON_in_kg, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic()+ggtitle("meg.27.7b-k8abd")
# sanity check - assuming we consider SOP between 0.95 and 1.05 as acceptable
intercatch_canum_checks$Acceptable <- ifelse(intercatch_canum_checks$SOP>0.94, "Acceptable", "Suspect")
intercatch_canum_checks$Acceptable <- ifelse(intercatch_canum_checks$SOP>1.05, "Suspect", intercatch_canum_checks$Acceptable)
ggplot(intercatch_canum_checks[intercatch_canum_checks$Stock == "sol.27.7fg",], aes(Acceptable, CATON_in_kg)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("sol.27.7fg")+xlab("")
ggplot(intercatch_canum_checks[intercatch_canum_checks$Stock == "meg.27.7b-k8abd",], aes(Acceptable, CATON_in_kg)) + geom_bar(stat="identity")+ facet_wrap(~Country) + theme_classic()+ggtitle("meg.27.7b-k8abd")+xlab("")
# ~ Adjustment _ I am not sure this is required - CM - need to ask PD and JB
#And they are not so now we take a ratio of of the unique(SOP_SUM over the caton to give us a ratio to multiply the No_at_age at)
#intercatch_canum3 <- intercatch_canum3 %>% group_by_at(vars(-SOP,-MeanWeight_in_g,-Number_at_age,-Age)) %>%  mutate(diff_ratio=unique(SOP_SUM)/unique(CATON_in_kg)) %>% ungroup() %>% mutate(No_At_Age_ADJ=Number_at_age*diff_ratio)
#~ Remove quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"CatchCat","lvl4", "Area","CATON_in_kg","CANUMType", "ageorlength","CANUM","MeanWeight_in_g", "samples_weight_kg")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,  Country, CatchCat, lvl4,  Area, CANUMType, ageorlength, CATON_in_kg, samples_weight_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T),  samples_weight_kg=sum(samples_weight_kg,na.rm = T))%>% data.frame()
#NOTE - warnings are due to no mean weights for HKE in 2009 for UKN, UKE and UKS.
intercatch_canum <- rbind(intercatch_canum_YEARS,intercatch_canum_QUARTER)
intercatch_canum <- intercatch_canum %>% select(Datayear, Country,Area , CatchCat,lvl4,CANUMType, ageorlength,CANUM, MeanWeight_in_g, samples_weight_kg,Stock)
names(intercatch_canum)
intercatch_canum$MeanWeight_in_g <-  as.numeric(intercatch_canum$MeanWeight_in_g)
# 02 - Convert length to age #####
#issue with mixed length units! https://shiny.marine.ie/igfs/
# ggplot(intercatch_canum_hke, aes(Length_new, MeanWeight_in_g)) + geom_point() +theme_classic() # ggplot(intercatch_canum_hke[intercatch_canum_hke$Length_new>1000 & intercatch_canum_hke$MeanWeight_in_g <10000,], aes(Length_new, MeanWeight_in_g)) + geom_point() +theme_classic()
names(intercatch_canum_hke)[17] <- "Length"
intercatch_canum_hke$Length_new <- intercatch_canum_hke$Length
intercatch_canum_hke$Length_new <- ifelse(intercatch_canum_hke$Length_new <250 & intercatch_canum_hke$MeanWeight_in_g>120, intercatch_canum_hke$Length_new*10, intercatch_canum_hke$Length_new)
intercatch_canum_hke <- intercatch_canum_hke[!intercatch_canum_hke$Length_new >750 & intercatch_canum_hke$MeanWeight_in_g<2500,]
intercatch_canum_hke$Length_new <- ifelse(intercatch_canum_hke$Length_new <30 & intercatch_canum_hke$MeanWeight_in_g>5, intercatch_canum_hke$Length_new*10, intercatch_canum_hke$Length_new)
#ggplot(intercatch_canum_hke, aes(Length_new, MeanWeight_in_g)) + geom_point() +theme_classic()
intercatch_canum_hke$Length <- intercatch_canum_hke$Length_new/10
intercatch_canum_hke <- intercatch_canum_hke[!is.na(intercatch_canum_hke$Stock),]
load("bootstrap/data/ices_intercatch/ALK/hke/alk.RData")
dimnames(alk); dim(alk)
# trends in alk per chort stara
# for (i in 1:24){
#   matrix.key <- prop.table(apply(alk[,,i],2,rev), margin=1)
#   alkPlot(matrix.key,"splines")
# }
# average across cohorts
hke_alk_year <- apply(alk, c(1,2), FUN=mean)
hke_alk_year <- prop.table(apply(hke_alk_year,2,rev), margin=1)
alkPlot(hke_alk_year,"splines") # sanity check
#apply alk
brks <- c(1,seq(2,100,2),110,120,130)
intercatch_canum_hke <- FSA::alkIndivAge(hke_alk_year,~Length  ,data=intercatch_canum_hke, type="SR", breaks=brks)
intercatch_canum_hke
intercatch_canum_hke_checks <- intercatch_canum_hke %>%   group_by(Datayear, Stock, Country, Area, CatchCat, CANUMType, CATON_in_kg ) %>% summarise(samples_weight_kg = sum(samples_weight_kg, na.rm=T)) %>% mutate(course_difference = (CATON_in_kg -samples_weight_kg) , SOP = (samples_weight_kg/ CATON_in_kg)) %>% data.frame()
intercatch_canum_hke_checks$Acceptable <- ifelse(intercatch_canum_hke_checks$SOP>0.94, "Acceptable", "Suspect")
intercatch_canum_hke_checks$Acceptable <- ifelse(intercatch_canum_hke_checks$SOP>1.05, "Suspect", intercatch_canum_hke_checks$Acceptable)
ggplot(intercatch_canum_hke_checks[intercatch_canum_hke_checks$Stock == "hke.27.3a46-8abd",], aes(CATON_in_kg, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic() +ggtitle("hke.27.3a46-8abd")
ggplot(intercatch_canum_hke_checks[intercatch_canum_hke_checks$Stock == "hke.27.3a46-8abd",], aes( Acceptable, CATON_in_kg)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("hke.27.3a46-8abd")+xlab("")
#plot new age data
ggplot(intercatch_canum_hke, aes(age, samples_weight_kg)) + geom_bar(stat="identity")+ theme_classic()
ggplot(intercatch_canum_hke, aes(age,samples_weight_kg)) + geom_bar(stat="identity")+ facet_wrap(~Datayear) + theme_classic()
ggplot(intercatch_canum_hke, aes(Datayear, CATON_in_kg)) + geom_bar(stat="identity") + theme_classic()
#conclusion delete all smaple data prior to 2011
intercatch_canum_hke <- intercatch_canum_hke[intercatch_canum_hke$Datayear>2010,]
#rerun sop checks
intercatch_canum_hke_checks <- intercatch_canum_hke %>%   group_by(Datayear, Stock, Country, Area, CatchCat, CANUMType, CATON_in_kg ) %>% summarise(samples_weight_kg = sum(samples_weight_kg, na.rm=T)) %>% mutate(course_difference = (CATON_in_kg -samples_weight_kg) , SOP = (samples_weight_kg/ CATON_in_kg)) %>% data.frame()
intercatch_canum_hke_checks$Acceptable <- ifelse(intercatch_canum_hke_checks$SOP>0.94, "Acceptable", "Suspect")
intercatch_canum_hke_checks$Acceptable <- ifelse(intercatch_canum_hke_checks$SOP>1.05, "Suspect", intercatch_canum_hke_checks$Acceptable)
ggplot(intercatch_canum_hke_checks[intercatch_canum_hke_checks$Stock == "hke.27.3a46-8abd",], aes(CATON_in_kg, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic() +ggtitle("hke.27.3a46-8abd")
ggplot(intercatch_canum_hke_checks[intercatch_canum_hke_checks$Stock == "hke.27.3a46-8abd",], aes( Acceptable, CATON_in_kg)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("hke.27.3a46-8abd")+xlab("")
#~ Remove quarter ~ aggregate ####
names(intercatch_canum)
#~ Remove quarter ~ aggregate ####
intercatch_canum_hke_new<- intercatch_canum_hke %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"CatchCat","lvl4", "Area","CATON_in_kg","CANUMType", "age","CANUM","MeanWeight_in_g", "samples_weight_kg")
intercatch_canum_hke_new <- intercatch_canum_hke_new %>% group_by(Datayear, Stock,  Country, CatchCat, lvl4,  Area, CANUMType, age, CATON_in_kg, samples_weight_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T),  samples_weight_kg=sum(samples_weight_kg,na.rm = T))%>% data.frame()
#~ Remove quarter ~ aggregate ####
intercatch_canum_hke<- intercatch_canum_hke %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"CatchCat","lvl4", "Area","CATON_in_kg","CANUMType", "age","CANUM","MeanWeight_in_g", "samples_weight_kg")
intercatch_canum_hke <- intercatch_canum_hke %>% group_by(Datayear, Stock,  Country, CatchCat, lvl4,  Area, CANUMType, age, CATON_in_kg, samples_weight_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T),  samples_weight_kg=sum(samples_weight_kg,na.rm = T))%>% data.frame()
names(intercatch_canum_hke)
str(intercatch_canum$MeanWeight_in_g )
names(intercatch_canum)
#~ Remove quarter ~ aggregate ####
intercatch_canum_hke<- intercatch_canum_hke %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"CatchCat","lvl4", "Area","CATON_in_kg","CANUMType", "age","CANUM","MeanWeight_in_g", "samples_weight_kg")
intercatch_canum_hke <- intercatch_canum_hke %>% group_by(Datayear, Stock,  Country, CatchCat, lvl4,  Area, CANUMType, age, CATON_in_kg, samples_weight_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T),  samples_weight_kg=sum(samples_weight_kg,na.rm = T))%>% data.frame()
intercatch_canum_hke <- intercatch_canum_hke %>% select(Datayear, Country,Area , CatchCat,lvl4,CANUMType, age,CANUM, MeanWeight_in_g, samples_weight_kg,Stock)
names(intercatch_canum_hke)
names(intercatch_canum_hke)[7] <- "Age"
# 03 - CANUM raised outside InterCatch - WGCSE ####
canum_cod <-  read.csv("bootstrap/data/ices_intercatch/canum_WG_COD_summary.csv")
canum_had <-  read.csv("bootstrap/data/ices_intercatch/canum_WG_HAD_summary.csv")
canum_whg <-  read.csv("bootstrap/data/ices_intercatch/canum_WG_WHG_summary.csv")
# ~ Stock fix ####
canum_cod$Stock<-"cod.27.7e-k"
canum_had$Stock<-"had.27.7b-k"
canum_whg$Stock<-"whg.27.7b-ce-k"
# ~ Métier level 4 fix
canum_cod$lvl4 <- canum_cod$fleet
canum_had$lvl4 <- canum_had$fleet
canum_whg$lvl4 <- canum_whg$fleet
# ~ Format fix ####
canum_cod <- canum_cod[canum_cod$year <2020,] # we only had access to this years file
canum_cod<- canum_cod %>% select(year, country, subArea  , catchCat   , lvl4, Age  , frequency1000  , meanWeightKg, Stock) %>%
group_by(year, country, subArea  , catchCat   , lvl4, Age, Stock ) %>% summarise(frequency1000 = sum(frequency1000, na.rm=T), Weight = weighted.mean(meanWeightKg,w=frequency1000,na.rm=T)) %>% data.frame() #CM needs to be changed to weighted mean when we get the right file
names(canum_cod) <- c("Year", "Country", "Area", "CatchCat", "lvl4", "Age", "Stock", "CANUM", "Mean_Weight_in_g")
canum_had <- canum_had %>% select(year, country, subArea, catchCat, lvl4, Age, frequency1000, meanWeightKg, Stock) %>%
group_by(year, country, subArea, catchCat, lvl4, Age, Stock) %>% summarise(frequency1000 = sum(frequency1000, na.rm=T), Weight = weighted.mean(meanWeightKg,w=frequency1000,na.rm=T)) %>% data.frame()
names(canum_had) <- c("Year", "Country", "Area", "CatchCat", "lvl4", "Age","Stock", "CANUM", "Mean_Weight_in_g")
canum_whg <- canum_whg %>% select(year, country, subArea, catchCat, lvl4, Age, frequency1000, meanWeightKg, Stock) %>%
group_by(year, country, subArea, catchCat, lvl4, Age, Stock) %>% summarise(frequency1000 = sum(frequency1000, na.rm=T), Weight = weighted.mean(meanWeightKg,w=frequency1000,na.rm=T)) %>% data.frame()
names(canum_whg) <- c("Year", "Country", "Area", "CatchCat", "lvl4", "Age","Stock", "CANUM", "Mean_Weight_in_g")
other_canum <- rbind(canum_cod, canum_whg, canum_had)
other_canum$Area <- as.character(other_canum$Area)
other_canum_saftey_check <- other_canum
# ~ Country fix  ####
other_canum <- left_join(other_canum,Country_Lookup)
dim(other_canum)[1]-dim(other_canum_saftey_check)[1] #safety check - dims should match
other_canum$Country <- other_canum$CorrectCountry
other_canum <- other_canum[-c(10)]
#~ SOP check of baseline data ####
other_caton <- read.csv("results/clean_data/intercatch_caton_summary.csv")
other_caton <- other_caton[other_caton$Stock %in% c("cod.27.7e-k" ,"had.27.7b-k", "whg.27.7b-ce-k"),]
other_caton$Area <- "27.7"
other_caton <- other_caton%>% select(Year, Stock, Country, Area,lvl4, Discards, Landings) %>%
group_by(Year, Stock, Country, Area,lvl4) %>%
summarise(Discards =sum(Discards, na.rm=T), Landings = sum(Landings ,na.rm=T))
other_caton <- gather(other_caton, key = CatchCat, value = "CATON", 6:7)
other_canum <- left_join(other_canum, other_caton, by= c("Year" = "Year", "Stock" = "Stock", "Country" = "Country", "Area" = "Area", "lvl4" = "lvl4", "CatchCat"= "CatchCat"))
other_canum$samples_weight_kg <- (other_canum$CANUM*other_canum$Mean_Weight_in_g)/1000 # put in kg
other_canum_checks <- other_canum %>%
group_by(Year, Stock, Country, Area, CatchCat, CATON) %>% summarise(samples_weight_kg = sum(samples_weight_kg, na.rm=T)) %>% mutate(course_difference = (CATON -samples_weight_kg) , SOP = (samples_weight_kg/ CATON)) %>% data.frame()
ggplot(other_canum_checks[other_canum_checks$Stock == "cod.27.7e-k",], aes(CATON, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic() +ggtitle("cod.27.7e-k")
# sanity check - assuming we consider SOP between 0.95 and 1.05 as acceptable
other_canum_checks$Acceptable <- ifelse(other_canum_checks$SOP>0.94, "Acceptable", "Suspect")
other_canum_checks$Acceptable <- ifelse(other_canum_checks$SOP>1.05, "Suspect", other_canum_checks$Acceptable)
ggplot(other_canum_checks[other_canum_checks$Stock == "cod.27.7e-k",], aes( Acceptable, CATON)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("cod.27.7e-k")+xlab("")
other_canum_checks <- other_canum %>%
group_by(Year, Stock, Country, Area, CatchCat, CATON) %>% summarise(samples_weight_kg = sum(samples_weight_kg, na.rm=T)) %>% mutate(course_difference = (CATON -samples_weight_kg) , SOP = (samples_weight_kg/ CATON)) %>% data.frame()
ggplot(other_canum_checks[other_canum_checks$Stock == "cod.27.7e-k",], aes(CATON, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic() +ggtitle("cod.27.7e-k")
ggplot(other_canum_checks[other_canum_checks$Stock == "had.27.7b-k",], aes(CATON, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic()+ggtitle("had.27.7b-k")
ggplot(other_canum_checks[other_canum_checks$Stock == "whg.27.7b-ce-k",], aes(CATON, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic()+ggtitle("whg.27.7b-ce-k")
# sanity check - assuming we consider SOP between 0.95 and 1.05 as acceptable
other_canum_checks$Acceptable <- ifelse(other_canum_checks$SOP>0.94, "Acceptable", "Suspect")
other_canum_checks$Acceptable <- ifelse(other_canum_checks$SOP>1.05, "Suspect", other_canum_checks$Acceptable)
ggplot(other_canum_checks[other_canum_checks$Stock == "cod.27.7e-k",], aes( Acceptable, CATON)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("cod.27.7e-k")+xlab("")
ggplot(other_canum_checks[other_canum_checks$Stock == "had.27.7b-k",], aes(Acceptable, CATON)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("had.27.7b-k")+xlab("")
ggplot(other_canum_checks[other_canum_checks$Stock == "whg.27.7b-ce-k",], aes(Acceptable, CATON)) + geom_bar(stat="identity")+ facet_wrap(~Country) + theme_classic()+ggtitle("whg.27.7b-ce-k")+xlab("")
str(other_canum)
names(other_canum)
names(intercatch_canum)
unique(intercatch_canum$CANUMType)
# ~ Adjustment _ I am not sure this is required - CM - need to ask PD and JB
#And they are not so now we take a ratio of of the unique(SOP_SUM over the caton to give us a ratio to multiply the No_at_age at)
#intercatch_canum3 <- intercatch_canum3 %>% group_by_at(vars(-SOP,-MeanWeight_in_g,-Number_at_age,-Age)) %>%  mutate(diff_ratio=unique(SOP_SUM)/unique(CATON_in_kg)) %>% ungroup() %>% mutate(No_At_Age_ADJ=Number_at_age*diff_ratio)
other_canum$CANUMType <- "Age"
other_canum <- other_canum %>% select(Year,Country, Area, CatchCat, lvl4, CANUMType, Age, CANUM, Mean_Weight_in_g,samples_weight_kg, Stock) )
other_canum <- other_canum %>% select(Year,Country, Area, CatchCat, lvl4, CANUMType, Age, CANUM, Mean_Weight_in_g,samples_weight_kg, Stock)
names(intercatch_canum)
intercatch_canum <- intercatch_canum %>% select(Datayear, Country,Area , CatchCat,lvl4, ageorlength,CANUM, MeanWeight_in_g, samples_weight_kg,Stock)
names(intercatch_canum)
names(intercatch_canum) <- c("Year","Country", "Area", "CatchCat", "lvl4", "Age", "CANUM", "Mean_Weight_in_g","samples_weight_kg", "Stock")
intercatch_canum$MeanWeight_in_g <-  as.numeric(intercatch_canum$MeanWeight_in_g)
intercatch_canum$Mean_Weight_in_g <-  as.numeric(intercatch_canum$MeanWeight_in_g)
intercatch_canum$Mean_Weight_in_g <-  as.numeric(intercatch_canum$Mean_Weight_in_g)
intercatch_canum_hke <- intercatch_canum_hke %>% select(Datayear, Country,Area , CatchCat,lvl4, ageorlength,CANUM, MeanWeight_in_g, samples_weight_kg,Stock)
intercatch_canum_hke <- intercatch_canum_hke %>% select(Datayear, Country,Area , CatchCat,lvl4, age,CANUM, MeanWeight_in_g, samples_weight_kg,Stock)
intercatch_canum_hke <- intercatch_canum_hke %>% select(Datayear, Country,Area , CatchCat,lvl4, Age,CANUM, MeanWeight_in_g, samples_weight_kg,Stock)
names(intercatch_canum_hke) <- c("Year","Country", "Area", "CatchCat", "lvl4", "Age", "CANUM", "Mean_Weight_in_g","samples_weight_kg", "Stock")
WGCSE_canum <- other_canum %>% select(Year,Country, Area, CatchCat, lvl4, Age, CANUM, Mean_Weight_in_g,samples_weight_kg, Stock)
# Data prep
# Preprocess data,
## Before: InterCatch extraction, data raised external to InterCatch, and ALK's
## After:  Age structure from InterCatch
# Notes: User must make sure that:
# 1 - factors are turned to characters,
# 2 - dim of data frame does not change shape during cleaning process
# Data sources vary per stock:
#       - InterCatch CANUM with distribution: meg.27.7b-k8abd, sol.27.7fg, hke.27.3a46-8abd(lengths only)
#       - Raised outside InterCatch: cod.27.7e-k, had.27.7b-k, whg.27.7b-ce-k, mon.27.78abd
gc()
rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
library(FSA)
# 01 - CANUM raised in InterCatch  ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
#subset for case study area
intercatch_canum <- intercatch_canum[intercatch_canum$Area %in% c("27.7"  , "27.7.b" , "27.7.c","27.7.c.1","27.7.c.2" , "27.7.d",  "27.7.e",  "27.7.f" , "27.7.g" , "27.7.h",  "27.7.j","27.7.j.1","27.7.j.2" , "27.7.k","27.7.k.1","27.7.k.2" ) & intercatch_canum$CatchCat %in% c("Discards", "Landings") & intercatch_canum$Stock %in% c("hke.27.3a46-8abd", "meg.27.7b-k8abd", "sol.27.7fg" ),]
# ~ Remove unwanted data ####
intercatch_canum <- intercatch_canum[intercatch_canum$CANUM>0,] #  CM -a number of hke with no canum, why?
intercatch_canum_saftey_check <- intercatch_canum #save for sanity checking later
intercatch_canum$samples_weight_kg <- (as.numeric(intercatch_canum$CANUM)*as.numeric(intercatch_canum$MeanWeight_in_g))/1000 # put in kg
intercatch_canum$MeanWeight_in_g <- as.numeric(intercatch_canum$MeanWeight_in_g)
sort(unique(intercatch_canum$Stock))
# 01 - CANUM raised in InterCatch  ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
sort(unique(intercatch_canum$Stock))
# 05 _ Merge and write out final CANUM #####
canum_summary <- rbind(intercatch_canum, intercatch_canum_hke, WGCSE_canum)
# Data prep
# Preprocess data,
## Before: InterCatch extraction, data raised external to InterCatch, and ALK's
## After:  Age structure from InterCatch
# Notes: User must make sure that:
# 1 - factors are turned to characters,
# 2 - dim of data frame does not change shape during cleaning process
# Data sources vary per stock:
#       - InterCatch CANUM with distribution: meg.27.7b-k8abd, sol.27.7fg, hke.27.3a46-8abd(lengths only)
#       - Raised outside InterCatch: cod.27.7e-k, had.27.7b-k, whg.27.7b-ce-k, mon.27.78abd
gc()
rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
library(FSA)
# 01 - CANUM raised in InterCatch  ####
taf.unzip("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.zip", files="2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
intercatch_canum <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2019 06 22 WGMIXFISH CANUM WECA for stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
#subset for case study area
intercatch_canum <- intercatch_canum[intercatch_canum$Area %in% c("27.7"  , "27.7.b" , "27.7.c","27.7.c.1","27.7.c.2" , "27.7.d",  "27.7.e",  "27.7.f" , "27.7.g" , "27.7.h",  "27.7.j","27.7.j.1","27.7.j.2" , "27.7.k","27.7.k.1","27.7.k.2" ) & intercatch_canum$CatchCat %in% c("Discards", "Landings") & intercatch_canum$Stock %in% c("hke.27.3a46-8abd", "meg.27.7b-k8abd", "sol.27.7fg" ),]
# ~ Remove unwanted data ####
intercatch_canum <- intercatch_canum[intercatch_canum$CANUM>0,] #  CM -a number of hke with no canum, why?
intercatch_canum_saftey_check <- intercatch_canum #save for sanity checking later
intercatch_canum$samples_weight_kg <- (as.numeric(intercatch_canum$CANUM)*as.numeric(intercatch_canum$MeanWeight_in_g))/1000 # put in kg
intercatch_canum$MeanWeight_in_g <- as.numeric(intercatch_canum$MeanWeight_in_g)
# ~ Area fix ####
area_spp_fix <- read.csv("bootstrap/data/supporting_files/Area_lookup.csv")
names(area_spp_fix) <- c("Area" ,"Standard","ICES_mix_correct", "ICES_FU","species_mix_FU" )
intercatch_canum <- left_join(intercatch_canum,area_spp_fix, by = "Area" )
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Area <- intercatch_canum$ICES_mix_correct
intercatch_canum <- intercatch_canum[-c(23,24,25,25)]
# ~ Country fix  ####
Country_Lookup <- read_xlsx("bootstrap/data/supporting_files/Country_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,Country_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$Country <- intercatch_canum$CorrectCountry
intercatch_canum <- intercatch_canum[-c(25)]
# ~ Métier level 4 fix ####
intercatch_canum$lvl4 <- substr(intercatch_canum$Fleet,1,7)
lvl4_Lookup <- read_xlsx("bootstrap/data/supporting_files/Metier_lvl4_lookup.xlsx")
intercatch_canum <- left_join(intercatch_canum,lvl4_Lookup)
dim(intercatch_canum)[1]-dim(intercatch_canum_saftey_check)[1] #safety check - dims should match
intercatch_canum$lvl4_new <- ifelse(is.na(intercatch_canum$Correct_lvl4),intercatch_canum$lvl4, intercatch_canum$Correct_lvl4)
intercatch_canum$lvl4 <- intercatch_canum$lvl4_new
intercatch_canum <- intercatch_canum[-c(26,27,28)]
# Remove length samples
intercatch_canum_hke <- intercatch_canum[intercatch_canum$Stock == "hke.27.3a46-8abd", ]
intercatch_canum <- intercatch_canum[!intercatch_canum$Stock == "hke.27.3a46-8abd", ]
#~ SOP check of baseline data ####
#needs to be done before you aggregate
intercatch_canum_checks <- intercatch_canum %>%   group_by(Datayear, Stock, Country, Area, CatchCat, CANUMType, CATON_in_kg ) %>% summarise(samples_weight_kg = sum(samples_weight_kg, na.rm=T)) %>% mutate(course_difference = (CATON_in_kg -samples_weight_kg) , SOP = (samples_weight_kg/ CATON_in_kg)) %>% data.frame()
ggplot(intercatch_canum_checks[intercatch_canum_checks$Stock == "sol.27.7fg",], aes(CATON_in_kg, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic()+ggtitle("sol.27.7fg")
ggplot(intercatch_canum_checks[intercatch_canum_checks$Stock == "meg.27.7b-k8abd",], aes(CATON_in_kg, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic()+ggtitle("meg.27.7b-k8abd")
# sanity check - assuming we consider SOP between 0.95 and 1.05 as acceptable
intercatch_canum_checks$Acceptable <- ifelse(intercatch_canum_checks$SOP>0.94, "Acceptable", "Suspect")
intercatch_canum_checks$Acceptable <- ifelse(intercatch_canum_checks$SOP>1.05, "Suspect", intercatch_canum_checks$Acceptable)
ggplot(intercatch_canum_checks[intercatch_canum_checks$Stock == "sol.27.7fg",], aes(Acceptable, CATON_in_kg)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("sol.27.7fg")+xlab("")
ggplot(intercatch_canum_checks[intercatch_canum_checks$Stock == "meg.27.7b-k8abd",], aes(Acceptable, CATON_in_kg)) + geom_bar(stat="identity")+ facet_wrap(~Country) + theme_classic()+ggtitle("meg.27.7b-k8abd")+xlab("")
# ~ Adjustment _ I am not sure this is required - CM - need to ask PD and JB
#And they are not so now we take a ratio of of the unique(SOP_SUM over the caton to give us a ratio to multiply the No_at_age at)
#intercatch_canum3 <- intercatch_canum3 %>% group_by_at(vars(-SOP,-MeanWeight_in_g,-Number_at_age,-Age)) %>%  mutate(diff_ratio=unique(SOP_SUM)/unique(CATON_in_kg)) %>% ungroup() %>% mutate(No_At_Age_ADJ=Number_at_age*diff_ratio)
#~ Remove quarter ~ aggregate ####
intercatch_canum<- intercatch_canum %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"CatchCat","lvl4", "Area","CATON_in_kg","CANUMType", "ageorlength","CANUM","MeanWeight_in_g", "samples_weight_kg")
intercatch_canum_YEARS <- intercatch_canum %>% filter(SeasonType %in%c("Year")) %>% select(-Season,-SeasonType)
intercatch_canum_QUARTER <- intercatch_canum %>% filter(!SeasonType %in%c("Year")) %>% select(-Season,-SeasonType) #NB CATON_in_kg is replicated
intercatch_canum_QUARTER <- intercatch_canum_QUARTER %>% group_by(Datayear, Stock,  Country, CatchCat, lvl4,  Area, CANUMType, ageorlength, CATON_in_kg, samples_weight_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T),  samples_weight_kg=sum(samples_weight_kg,na.rm = T))%>% data.frame()
#NOTE - warnings are due to no mean weights for HKE in 2009 for UKN, UKE and UKS.
intercatch_canum <- rbind(intercatch_canum_YEARS,intercatch_canum_QUARTER)
intercatch_canum <- intercatch_canum %>% select(Datayear, Country,Area , CatchCat,lvl4, ageorlength,CANUM, MeanWeight_in_g, samples_weight_kg,Stock)
names(intercatch_canum) <- c("Year","Country", "Area", "CatchCat", "lvl4", "Age", "CANUM", "Mean_Weight_in_g","samples_weight_kg", "Stock")
# 02 - Convert length to age #####
#issue with mixed length units! https://shiny.marine.ie/igfs/
# ggplot(intercatch_canum_hke, aes(Length_new, MeanWeight_in_g)) + geom_point() +theme_classic() # ggplot(intercatch_canum_hke[intercatch_canum_hke$Length_new>1000 & intercatch_canum_hke$MeanWeight_in_g <10000,], aes(Length_new, MeanWeight_in_g)) + geom_point() +theme_classic()
names(intercatch_canum_hke)[17] <- "Length"
intercatch_canum_hke$Length_new <- intercatch_canum_hke$Length
intercatch_canum_hke$Length_new <- ifelse(intercatch_canum_hke$Length_new <250 & intercatch_canum_hke$MeanWeight_in_g>120, intercatch_canum_hke$Length_new*10, intercatch_canum_hke$Length_new)
intercatch_canum_hke <- intercatch_canum_hke[!intercatch_canum_hke$Length_new >750 & intercatch_canum_hke$MeanWeight_in_g<2500,]
intercatch_canum_hke$Length_new <- ifelse(intercatch_canum_hke$Length_new <30 & intercatch_canum_hke$MeanWeight_in_g>5, intercatch_canum_hke$Length_new*10, intercatch_canum_hke$Length_new)
#ggplot(intercatch_canum_hke, aes(Length_new, MeanWeight_in_g)) + geom_point() +theme_classic()
intercatch_canum_hke$Length <- intercatch_canum_hke$Length_new/10
intercatch_canum_hke <- intercatch_canum_hke[!is.na(intercatch_canum_hke$Stock),]
load("bootstrap/data/ices_intercatch/ALK/hke/alk.RData")
dimnames(alk); dim(alk)
# trends in alk per chort stara
# for (i in 1:24){
#   matrix.key <- prop.table(apply(alk[,,i],2,rev), margin=1)
#   alkPlot(matrix.key,"splines")
# }
# average across cohorts
hke_alk_year <- apply(alk, c(1,2), FUN=mean)
hke_alk_year <- prop.table(apply(hke_alk_year,2,rev), margin=1)
alkPlot(hke_alk_year,"splines") # sanity check
#apply alk
brks <- c(1,seq(2,100,2),110,120,130)
intercatch_canum_hke <- FSA::alkIndivAge(hke_alk_year,~Length  ,data=intercatch_canum_hke, type="SR", breaks=brks)
intercatch_canum_hke
intercatch_canum_hke_checks <- intercatch_canum_hke %>%   group_by(Datayear, Stock, Country, Area, CatchCat, CANUMType, CATON_in_kg ) %>% summarise(samples_weight_kg = sum(samples_weight_kg, na.rm=T)) %>% mutate(course_difference = (CATON_in_kg -samples_weight_kg) , SOP = (samples_weight_kg/ CATON_in_kg)) %>% data.frame()
intercatch_canum_hke_checks$Acceptable <- ifelse(intercatch_canum_hke_checks$SOP>0.94, "Acceptable", "Suspect")
intercatch_canum_hke_checks$Acceptable <- ifelse(intercatch_canum_hke_checks$SOP>1.05, "Suspect", intercatch_canum_hke_checks$Acceptable)
ggplot(intercatch_canum_hke_checks[intercatch_canum_hke_checks$Stock == "hke.27.3a46-8abd",], aes(CATON_in_kg, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic() +ggtitle("hke.27.3a46-8abd")
ggplot(intercatch_canum_hke_checks[intercatch_canum_hke_checks$Stock == "hke.27.3a46-8abd",], aes( Acceptable, CATON_in_kg)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("hke.27.3a46-8abd")+xlab("")
#plot new age data
ggplot(intercatch_canum_hke, aes(age, samples_weight_kg)) + geom_bar(stat="identity")+ theme_classic()
ggplot(intercatch_canum_hke, aes(age,samples_weight_kg)) + geom_bar(stat="identity")+ facet_wrap(~Datayear) + theme_classic()
ggplot(intercatch_canum_hke, aes(Datayear, CATON_in_kg)) + geom_bar(stat="identity") + theme_classic()
#conclusion delete all smaple data prior to 2011
intercatch_canum_hke <- intercatch_canum_hke[intercatch_canum_hke$Datayear>2010,]
#rerun sop checks
intercatch_canum_hke_checks <- intercatch_canum_hke %>%   group_by(Datayear, Stock, Country, Area, CatchCat, CANUMType, CATON_in_kg ) %>% summarise(samples_weight_kg = sum(samples_weight_kg, na.rm=T)) %>% mutate(course_difference = (CATON_in_kg -samples_weight_kg) , SOP = (samples_weight_kg/ CATON_in_kg)) %>% data.frame()
intercatch_canum_hke_checks$Acceptable <- ifelse(intercatch_canum_hke_checks$SOP>0.94, "Acceptable", "Suspect")
intercatch_canum_hke_checks$Acceptable <- ifelse(intercatch_canum_hke_checks$SOP>1.05, "Suspect", intercatch_canum_hke_checks$Acceptable)
ggplot(intercatch_canum_hke_checks[intercatch_canum_hke_checks$Stock == "hke.27.3a46-8abd",], aes(CATON_in_kg, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic() +ggtitle("hke.27.3a46-8abd")
ggplot(intercatch_canum_hke_checks[intercatch_canum_hke_checks$Stock == "hke.27.3a46-8abd",], aes( Acceptable, CATON_in_kg)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("hke.27.3a46-8abd")+xlab("")
#~ Remove quarter ~ aggregate ####
intercatch_canum_hke<- intercatch_canum_hke %>% select("Datayear" ,"Stock" ,"Season","SeasonType","Country" ,"CatchCat","lvl4", "Area","CATON_in_kg","CANUMType", "age","CANUM","MeanWeight_in_g", "samples_weight_kg")
intercatch_canum_hke <- intercatch_canum_hke %>% group_by(Datayear, Stock,  Country, CatchCat, lvl4,  Area, CANUMType, age, CATON_in_kg, samples_weight_kg) %>% summarise(MeanWeight_in_g = weighted.mean(as.numeric(MeanWeight_in_g), CANUM), CANUM=sum(CANUM,na.rm = T),  samples_weight_kg=sum(samples_weight_kg,na.rm = T))%>% data.frame()
intercatch_canum_hke <- intercatch_canum_hke %>% select(Datayear, Country,Area , CatchCat,lvl4,CANUMType, age,CANUM, MeanWeight_in_g, samples_weight_kg,Stock)
intercatch_canum_hke <- intercatch_canum_hke %>% select(Datayear, Country,Area , CatchCat,lvl4, age,CANUM, MeanWeight_in_g, samples_weight_kg,Stock)
names(intercatch_canum_hke) <- c("Year","Country", "Area", "CatchCat", "lvl4", "Age", "CANUM", "Mean_Weight_in_g","samples_weight_kg", "Stock")
# 03 - CANUM raised outside InterCatch - WGCSE ####
canum_cod <-  read.csv("bootstrap/data/ices_intercatch/canum_WG_COD_summary.csv")
canum_had <-  read.csv("bootstrap/data/ices_intercatch/canum_WG_HAD_summary.csv")
canum_whg <-  read.csv("bootstrap/data/ices_intercatch/canum_WG_WHG_summary.csv")
# ~ Stock fix ####
canum_cod$Stock<-"cod.27.7e-k"
canum_had$Stock<-"had.27.7b-k"
canum_whg$Stock<-"whg.27.7b-ce-k"
# ~ Métier level 4 fix
canum_cod$lvl4 <- canum_cod$fleet
canum_had$lvl4 <- canum_had$fleet
canum_whg$lvl4 <- canum_whg$fleet
# ~ Format fix ####
canum_cod <- canum_cod[canum_cod$year <2020,] # we only had access to this years file
canum_cod<- canum_cod %>% select(year, country, subArea  , catchCat   , lvl4, Age  , frequency1000  , meanWeightKg, Stock) %>%
group_by(year, country, subArea  , catchCat   , lvl4, Age, Stock ) %>% summarise(frequency1000 = sum(frequency1000, na.rm=T), Weight = weighted.mean(meanWeightKg,w=frequency1000,na.rm=T)) %>% data.frame() #CM needs to be changed to weighted mean when we get the right file
names(canum_cod) <- c("Year", "Country", "Area", "CatchCat", "lvl4", "Age", "Stock", "CANUM", "Mean_Weight_in_g")
canum_had <- canum_had %>% select(year, country, subArea, catchCat, lvl4, Age, frequency1000, meanWeightKg, Stock) %>%
group_by(year, country, subArea, catchCat, lvl4, Age, Stock) %>% summarise(frequency1000 = sum(frequency1000, na.rm=T), Weight = weighted.mean(meanWeightKg,w=frequency1000,na.rm=T)) %>% data.frame()
names(canum_had) <- c("Year", "Country", "Area", "CatchCat", "lvl4", "Age","Stock", "CANUM", "Mean_Weight_in_g")
canum_whg <- canum_whg %>% select(year, country, subArea, catchCat, lvl4, Age, frequency1000, meanWeightKg, Stock) %>%
group_by(year, country, subArea, catchCat, lvl4, Age, Stock) %>% summarise(frequency1000 = sum(frequency1000, na.rm=T), Weight = weighted.mean(meanWeightKg,w=frequency1000,na.rm=T)) %>% data.frame()
names(canum_whg) <- c("Year", "Country", "Area", "CatchCat", "lvl4", "Age","Stock", "CANUM", "Mean_Weight_in_g")
other_canum <- rbind(canum_cod, canum_whg, canum_had)
other_canum$Area <- as.character(other_canum$Area)
other_canum_saftey_check <- other_canum
# ~ Country fix  ####
other_canum <- left_join(other_canum,Country_Lookup)
dim(other_canum)[1]-dim(other_canum_saftey_check)[1] #safety check - dims should match
other_canum$Country <- other_canum$CorrectCountry
other_canum <- other_canum[-c(10)]
#~ SOP check of baseline data ####
other_caton <- read.csv("results/clean_data/intercatch_caton_summary.csv")
other_caton <- other_caton[other_caton$Stock %in% c("cod.27.7e-k" ,"had.27.7b-k", "whg.27.7b-ce-k"),]
other_caton$Area <- "27.7"
other_caton <- other_caton%>% select(Year, Stock, Country, Area,lvl4, Discards, Landings) %>%
group_by(Year, Stock, Country, Area,lvl4) %>%
summarise(Discards =sum(Discards, na.rm=T), Landings = sum(Landings ,na.rm=T))
other_caton <- gather(other_caton, key = CatchCat, value = "CATON", 6:7)
other_canum <- left_join(other_canum, other_caton, by= c("Year" = "Year", "Stock" = "Stock", "Country" = "Country", "Area" = "Area", "lvl4" = "lvl4", "CatchCat"= "CatchCat"))
other_canum$samples_weight_kg <- (other_canum$CANUM*other_canum$Mean_Weight_in_g)/1000 # put in kg
other_canum_checks <- other_canum %>%
group_by(Year, Stock, Country, Area, CatchCat, CATON) %>% summarise(samples_weight_kg = sum(samples_weight_kg, na.rm=T)) %>% mutate(course_difference = (CATON -samples_weight_kg) , SOP = (samples_weight_kg/ CATON)) %>% data.frame()
ggplot(other_canum_checks[other_canum_checks$Stock == "cod.27.7e-k",], aes(CATON, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic() +ggtitle("cod.27.7e-k")
ggplot(other_canum_checks[other_canum_checks$Stock == "had.27.7b-k",], aes(CATON, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic()+ggtitle("had.27.7b-k")
ggplot(other_canum_checks[other_canum_checks$Stock == "whg.27.7b-ce-k",], aes(CATON, SOP)) + geom_point() + facet_wrap(~Country) + theme_classic()+ggtitle("whg.27.7b-ce-k")
# sanity check - assuming we consider SOP between 0.95 and 1.05 as acceptable
other_canum_checks$Acceptable <- ifelse(other_canum_checks$SOP>0.94, "Acceptable", "Suspect")
other_canum_checks$Acceptable <- ifelse(other_canum_checks$SOP>1.05, "Suspect", other_canum_checks$Acceptable)
ggplot(other_canum_checks[other_canum_checks$Stock == "cod.27.7e-k",], aes( Acceptable, CATON)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("cod.27.7e-k")+xlab("")
ggplot(other_canum_checks[other_canum_checks$Stock == "had.27.7b-k",], aes(Acceptable, CATON)) + geom_bar(stat="identity") + facet_wrap(~Country) + theme_classic()+ggtitle("had.27.7b-k")+xlab("")
ggplot(other_canum_checks[other_canum_checks$Stock == "whg.27.7b-ce-k",], aes(Acceptable, CATON)) + geom_bar(stat="identity")+ facet_wrap(~Country) + theme_classic()+ggtitle("whg.27.7b-ce-k")+xlab("")
# ~ Adjustment _ I am not sure this is required - CM - need to ask PD and JB
#And they are not so now we take a ratio of of the unique(SOP_SUM over the caton to give us a ratio to multiply the No_at_age at)
# intercatch_canum3 <- intercatch_canum3 %>% group_by_at(vars(-SOP,-MeanWeight_in_g,-Number_at_age,-Age)) %>%  mutate(diff_ratio=unique(SOP_SUM)/unique(CATON_in_kg)) %>% ungroup() %>% mutate(No_At_Age_ADJ=Number_at_age*diff_ratio)
WGCSE_canum <- other_canum %>% select(Year,Country, Area, CatchCat, lvl4, Age, CANUM, Mean_Weight_in_g,samples_weight_kg, Stock)
# 04 - CANUM raised outside InterCatch - WGBIE ####
# mon.27.78abd
# So we have been give numbers at length
# Need to apply that to the metier intercatch
# perhaps get alk from IAMS?
# 05 _ Merge and write out final CANUM #####
canum_summary <- rbind(intercatch_canum, intercatch_canum_hke, WGCSE_canum)
write.taf(intercatch_canum, intercatch_canum_hke, WGCSE_canum, file.path("results/clean_data/intercatch_canum_summary.csv"))
write.taf(canum_summary, file.path("results/clean_data/intercatch_canum_summary.csv"))
write.taf(canum_summary, file.path("results/clean_data/canum_summary.csv"))
# Data prep
# Preprocess data,
## Before: InterCatch extraction, data raised external to InterCatch, and ALK's
## After:  Discards rates
# Data sources vary per stock:
#       - InterCatch CATON with distribution: meg.27.7b-k8abd, sol.27.7fg, hke.27.3a46-8abd
#       - InterCatch CATON without distribution: mon.27.78abd
#       - Raised outside InterCatch: cod.27.7e-k, had.27.7b-k, whg.27.7b-ce-k,
#       - Supplied by NEP expert: nep.fu.16, nep.fu.17, nep.fu.19, nep.fu.2021, nep.fu.22, nep.out.7
# Notes: User must make sure that: factors are turned to characters and dim of data frame does not change shape during cleaning process
gc();rm(list = ls())
library(readxl)
library(tidyr)
library(dplyr)
library(icesTAF)
library(ggplot2)
# 01 - InterCatch CATON ####
# with distributions
taf.unzip("bootstrap/data/ices_intercatch/2020 06 22 WGMIXFISH CATON Stocks with distributions all WG 2002  2019.zip", files="2020 06 22 WGMIXFISH CATON stocks with distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
#NB gitignore this file as it is too big
intercatch_caton <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2020 06 22 WGMIXFISH CATON stocks with distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
# without distributions
taf.unzip("bootstrap/data/ices_intercatch/2020 06 22 WGMIXFISH CATON stocks withOUT distributions all WG 2002 2019.zip", files="2020 06 22 WGMIXFISH CATON stocks withOUT distributions all WG 2002 2019.csv", exdir="bootstrap/data/ices_intercatch")
#NB gitignore this file as it is too big
intercatch_caton_no_dist <-  read.csv(file = file.path("bootstrap/data/ices_intercatch/2020 06 22 WGMIXFISH CATON stocks withOUT distributions all WG 2002 2019.csv"),fileEncoding = "UTF-8-BOM")
names(intercatch_caton_no_dist) <- names(intercatch_caton)
intercatch_caton <- rbind(intercatch_caton_no_dist, intercatch_caton)
#subset for case study area
intercatch_caton <- intercatch_caton %>% filter(Area %in% c("27.7"  , "27.7.b" , "27.7.c","27.7.c.1","27.7.c.2" , "27.7.d",  "27.7.e",  "27.7.f" , "27.7.g" , "27.7.h",  "27.7.j","27.7.j.1","27.7.j.2" , "27.7.k","27.7.k.1","27.7.k.2" ))
intercatch_caton_saftey_check <- intercatch_caton #save for sanity checking later
# ~ Area fix ####
area_spp_fix <- read.csv("bootstrap/data/supporting_files/Area_lookup.csv")
names(area_spp_fix) <- c("Area" ,"Standard","ICES_mix_correct", "ICES_FU","species_mix_FU" )
intercatch_caton <- left_join(intercatch_caton,area_spp_fix, by = "Area" )
dim(intercatch_caton)[1]-dim(intercatch_caton_saftey_check)[1] #safety check - dims should match
intercatch_caton$Area <- intercatch_caton$ICES_mix_correct
intercatch_caton <- intercatch_caton[-c(13,14,15,16)]
# ~ Country fix  ####
Country_Lookup <- read_xlsx("bootstrap/data/supporting_files/Country_lookup.xlsx")
intercatch_caton <- left_join(intercatch_caton,Country_Lookup)
dim(intercatch_caton)[1]-dim(intercatch_caton_saftey_check)[1] #safety check - dims should match
intercatch_caton$Country <- intercatch_caton$CorrectCountry
intercatch_caton <- intercatch_caton[-c(13)]
# ~ Species fix ####
intercatch_caton$Species <- toupper(substr(intercatch_caton$Stock,1,3))
# ~ M?tier level 4 fix ####
intercatch_caton$lvl4 <- substr(intercatch_caton$fleet,1,7)
lvl4_Lookup <- read_xlsx("bootstrap/data/supporting_files/Metier_lvl4_lookup.xlsx")
intercatch_caton <- left_join(intercatch_caton,lvl4_Lookup)
dim(intercatch_caton)[1]-dim(intercatch_caton_saftey_check)[1] #safety check - dims should match
intercatch_caton$lvl4_new <- ifelse(is.na(intercatch_caton$Correct_lvl4),intercatch_caton$lvl4, intercatch_caton$Correct_lvl4)
intercatch_caton$lvl4 <- intercatch_caton$lvl4_new
intercatch_caton <- intercatch_caton[-c(15,16,17)]
# ~ Remove unwanted data ####
intercatch_caton <-intercatch_caton [!intercatch_caton$CatchCat %in% c("BMS landing", "Logbook Registered Discard"),]
intercatch_caton<- intercatch_caton%>% select("DataYear" ,"Stock" ,"Country" ,"fleet" ,"CatchCat","Weight_Total_in_kg","lvl4", "Area","Species")
names(intercatch_caton) <-  c("Year", "Stock","Country" ,"Fleet" , "CatchCat", "CATON_in_kg", "lvl4", "Area" , "Species")
intercatch_caton <- intercatch_caton[!intercatch_caton$Species %in% c("COD", "WHG", "HAD"),] # Different data source used for these stocks!
# ~ Calculating discard rates ####
intercatch_caton<- intercatch_caton %>% select(Year,Stock, Country,Area,lvl4,CatchCat,CATON_in_kg) %>%
group_by(Year,Stock,Country,Area,lvl4,CatchCat) %>%  dplyr::summarise(CATON_in_kg=sum(CATON_in_kg, na.rm=TRUE))%>%
tidyr::spread(CatchCat,CATON_in_kg)
intercatch_caton$Catch<-rowSums(intercatch_caton[c("Discards","Landings")],na.rm=T)
intercatch_caton$DR<-intercatch_caton$Discards/intercatch_caton$Catch
# CM need to compare MON totals to that in stock overview!
# 02 - CATON raised outside InterCatch ####
caton_cod <-  read.csv("bootstrap/data/ices_intercatch/caton_WG_COD_summary.csv")
caton_had <-  read.csv("bootstrap/data/ices_intercatch/caton_WG_HAD_summary.csv")
caton_whg <-  read.csv("bootstrap/data/ices_intercatch/caton_WG_WHG_summary.csv")
# ~ Fix and merge ####
caton_cod$Stock<-"cod.27.7e-k"
caton_had$Stock<-"had.27.7b-k"
caton_whg$Stock<-"whg.27.7b-ce-k"
caton_other<-rbind(caton_cod,caton_had,caton_whg)
names(caton_other)<-c("Year","Country","Area","lvl4","Landings","Discards","Stock")
caton_other$lvl4<-substr(caton_other$lvl4,1,7)
# ~ Calculating discard rates ####
caton_other <- caton_other %>% group_by(Year, Country, Area, lvl4, Stock) %>% summarise("Landings" = sum(Landings, na.rm=T), "Discards" = sum(Discards, na.rm=T))
caton_other$Catch <- rowSums(caton_other[c("Discards","Landings")],na.rm=T)
caton_other$DR <- caton_other$Discards/caton_other$Catch
# ~ fix caton countrys ----------------------------------------------------
caton_other2 <- left_join(caton_other,Country_Lookup)
dim(caton_other2)[1]-dim(caton_other)[1] #safety check - dims should match
caton_other2$Country <- caton_other2$CorrectCountry
table(caton_other2$Country)
# 03 - Merge data sources and write out
caton_summary<-rbind(intercatch_caton,caton_other2)
# ~ Check for no discard data ---------------------------------------------
table(is.na(caton_summary$Discards))
##note the alternative way to deal with this is is to assign 0 to the NA values and 0 to the DR rate for NA
## however NA typically implies no data not a zero discard rate so there could be a major assumtion there that
## is wrong
NA_NaN_IC_DR <- caton_summary %>% filter(is.nan(DR)==T | is.na(Discards)==T)
caton_summary_fin <- caton_summary %>% filter(is.na(Discards)==F , is.nan(DR)==F)
dim(caton_summary)[1]-(dim(caton_summary_fin)[1]+dim(NA_NaN_IC_DR)[1])
write.taf(caton_summary_fin,"results/clean_data/caton_summary.csv")
# 04 - CANUM raised outside InterCatch - WGBIE ####
# mon.27.78abd
# So we have been give numbers at length
# Need to apply that to the metier intercatch
# perhaps get alk from IAMS?
caton <- read.csv("results/clean_data/caton_summary.csv")
unique(caton$Stock)
caton <- caton[caton$Stock == "mon.27.78abd",]
load("bootstrap/data/ices_intercatch/ALK/hke/alk.RData")
dimnames(alk); dim(alk)
